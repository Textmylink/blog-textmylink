{% extends "layouts/base.njk" %}
{% set heroImage = image | default("") | trim %}
{% set shareImage = seo_image or heroImage or site.image %}
{% set shareImageAbsolute = shareImage | toAbsoluteUrl %}
{% if shareImageAbsolute %}
  {% set structuredImages = [shareImageAbsolute] %}
{% else %}
  {% set structuredImages = [] %}
{% endif %}
{% set postTitle = title or site.title %}
{% set displayDescription = description or (content | excerpt(160)) %}
{% set canonicalUrl = page.url | toAbsoluteUrl %}
{% set previousPost = collections.posts | getPreviousCollectionItem(page) %}
{% set nextPost = collections.posts | getNextCollectionItem(page) %}

{% block head %}
  {% set og_type = "article" %}
  {% set filteredTags = (tags | filterTags) %}
  {% set primarySection = filteredTags | first %}
  {% if filteredTags and filteredTags | length %}
    {% set keywordString = filteredTags | join(', ') %}
  {% else %}
    {% set keywordString = "" %}
  {% endif %}
  {% set structuredDescription = (seo_description or description or content | excerpt(180) or site.description) %}
  {{ super() }}
  {% if filteredTags and filteredTags | length %}
    <meta name="keywords" content="{{ filteredTags | join(', ') }}">
  {% endif %}
  <script type="application/ld+json">
    {{
      {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage": canonicalUrl,
        "headline": postTitle,
        "description": structuredDescription,
        "image": structuredImages,
        "url": canonicalUrl,
        "articleSection": primarySection,
        "keywords": keywordString,
        "datePublished": date | isoDate,
        "dateModified": (page.date or date) | isoDate,
        "author": {
          "@type": "Person",
          "name": author or site.author
        },
        "publisher": {
          "@type": "Organization",
          "name": site.organization.name,
          "logo": {
            "@type": "ImageObject",
            "url": site.organization.logo | toAbsoluteUrl
          }
        }
      } | dump | safe
    }}
  </script>
{% endblock %}

{% block content %}
  {% if heroImage and heroImage | length > 4 %}
    <figure class="post-hero">
      <img src="{{ heroImage }}" alt="{{ postTitle }} featured image">
    </figure>
  {% endif %}
  <header class="post-header">
    <p class="post-meta">
      <time datetime="{{ date | isoDate }}">{{ date | readableDate }}</time>
      {% if author %}
        &nbsp;&middot;&nbsp; {{ author }}
      {% endif %}
    </p>
    <h1>{{ postTitle }}</h1>
    {% if displayDescription %}
      <p>{{ displayDescription }}</p>
    {% endif %}
  </header>
  <article class="post-body">
    {{ content | safe }}
  </article>
  <nav class="neighbor-posts" aria-label="Post pagination">
    {% if previousPost %}
      <a class="neighbor-posts__link neighbor-posts__link--prev" href="{{ previousPost.url }}">
        <span class="neighbor-posts__label">Next Post</span>
        <span class="neighbor-posts__title">{{ previousPost.data.title }}</span>
      </a>
    {% else %}
      <span class="neighbor-posts__placeholder">
        <span class="neighbor-posts__label">Next Post</span>
        <span class="neighbor-posts__title">More stories coming soon.</span>
      </span>
    {% endif %}
    {% if nextPost %}
      <a class="neighbor-posts__link neighbor-posts__link--next" href="{{ nextPost.url }}">
        <span class="neighbor-posts__label">Previous Post</span>
        <span class="neighbor-posts__title">{{ nextPost.data.title }}</span>
      </a>
    {% else %}
      <span class="neighbor-posts__placeholder">
        <span class="neighbor-posts__label">Previous Post</span>
        <span class="neighbor-posts__title"></span>
      </span>
    {% endif %}
  </nav>
{% endblock %}
