<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TextMyLink CMS</title>
    <style>
      :root {
        color-scheme: light;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      body {
        margin: 0;
        background: #f1f5f9;
        color: #0f172a;
      }
      body.cms-nav-open {
        overflow: hidden;
      }
      #cms-mobile-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: #0f172a;
        color: #f8fafc;
      }
      #cms-mobile-header button {
        background: none;
        border: none;
        color: inherit;
        font: inherit;
        cursor: pointer;
      }
      #cms-mobile-header button:focus-visible {
        outline: 2px solid #38bdf8;
        outline-offset: 2px;
      }
      #cms-mobile-header .cms-brand {
        font-weight: 600;
        font-size: 1.05rem;
      }
      #cms-nav-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.5rem;
        border-radius: 0.5rem;
      }
      #cms-nav-toggle .cms-hamburger {
        display: inline-flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      #cms-nav-toggle .cms-hamburger span {
        display: block;
        width: 1.3rem;
        height: 0.14rem;
        background: currentColor;
        border-radius: 1rem;
      }
      body.cms-nav-open #cms-nav-toggle {
        color: #38bdf8;
      }
      #cms-logout-button {
        margin-left: auto;
        padding: 0.35rem 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid rgba(255, 255, 255, 0.35);
      }
      #cms-logout-button:hover {
        background: rgba(255, 255, 255, 0.12);
      }
      #nc-root.cms-mobile-root {
        min-height: calc(100vh - 3.5rem);
        display: flex;
        flex-direction: column;
      }
      #nc-root.cms-mobile-root .nc-app,
      #nc-root.cms-mobile-root [data-testid="app-container"],
      #nc-root.cms-mobile-root [class*="AppLayout"] {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
      }
      #nc-root.cms-mobile-root .nc-app-header,
      #nc-root.cms-mobile-root [class*="AppHeader"],
      #nc-root.cms-mobile-root header[role="banner"] {
        display: none !important;
      }
      #nc-root.cms-mobile-root .cms-mobile-nav,
      #nc-root.cms-mobile-root [data-testid="collection-sidebar"],
      #nc-root.cms-mobile-root nav[aria-label="Collections"],
      #nc-root.cms-mobile-root aside[aria-label="Collections"] {
        width: 100% !important;
        max-width: none !important;
        border: none !important;
        border-bottom: 1px solid #cbd5f5;
        background: #e2e8f0;
        padding: 0.5rem 1rem;
        box-sizing: border-box;
        display: none;
      }
      body.cms-nav-open #nc-root.cms-mobile-root .cms-mobile-nav,
      body.cms-nav-open #nc-root.cms-mobile-root [data-testid="collection-sidebar"],
      body.cms-nav-open #nc-root.cms-mobile-root nav[aria-label="Collections"],
      body.cms-nav-open #nc-root.cms-mobile-root aside[aria-label="Collections"] {
        display: block;
      }
      .cms-mobile-nav ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .cms-mobile-nav a {
        display: block;
        padding: 0.55rem 0.65rem;
        border-radius: 0.5rem;
        color: #0f172a;
        text-decoration: none;
        font-weight: 500;
      }
      .cms-mobile-nav a:hover {
        background: #cbd5f5;
      }
      #nc-root.cms-mobile-root .cms-mobile-pane,
      #nc-root.cms-mobile-root [data-testid="collection-content"],
      #nc-root.cms-mobile-root [data-testid="editor-pane"],
      #nc-root.cms-mobile-root main,
      #nc-root.cms-mobile-root [role="main"] {
        flex: 1 1 auto;
        padding: 1rem;
        min-height: 0;
        overflow: auto;
      }
      #nc-root.cms-mobile-root form {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      #nc-root.cms-mobile-root input,
      #nc-root.cms-mobile-root select,
      #nc-root.cms-mobile-root textarea {
        font: inherit;
        padding: 0.6rem 0.75rem;
        border: 1px solid #cbd5f5;
        border-radius: 0.5rem;
        width: 100%;
        box-sizing: border-box;
        background: #fff;
      }
      #nc-root.cms-mobile-root [data-testid="entry-card"],
      #nc-root.cms-mobile-root [class*="EntryCard"],
      #nc-root.cms-mobile-root [class*="CollectionListCard"] {
        padding: 0.75rem;
        border-radius: 0.75rem;
        border: 1px solid #cbd5f5;
        background: #fff;
        margin-bottom: 0.75rem;
      }
      #nc-root.cms-mobile-root table {
        width: 100%;
        border-collapse: collapse;
      }
      #nc-root.cms-mobile-root th,
      #nc-root.cms-mobile-root td {
        padding: 0.5rem;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
      }
      @media (min-width: 900px) {
        #nc-root.cms-mobile-root {
          margin: 0 auto;
          max-width: 960px;
        }
      }
    </style>
  </head>
  <body>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", function (user) {
          if (!user) {
            window.netlifyIdentity.on("login", function () {
              document.location.href = "/admin/";
            });
          }
        });
      }
    </script>
    <script>
      window.process = window.process || { env: { NODE_ENV: "production" } };
      window.CMS_MANUAL_INIT = true;
    </script>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      (function initCms() {
        if (window.CMS && typeof window.CMS.init === "function") {
          window.CMS.init();
          setupIdentityUI();
          setupMobileShell();
          return;
        }
        if (window.NetlifyCmsApp && typeof window.NetlifyCmsApp.init === "function") {
          window.NetlifyCmsApp.init();
          setupIdentityUI();
          setupMobileShell();
          return;
        }
        const message = "Netlify CMS failed to load. Check the browser console for details.";
        console.error(message);
        document.body.insertAdjacentHTML("beforeend", `<p>${message}</p>`);
      })();

      function setupIdentityUI() {
        if (!window.netlifyIdentity) {
          return;
        }

        const cleanIdentityModal = () => {
          const modal = document.querySelector(".netlify-identity-modal");
          if (!modal) return;

          const tabs = modal.querySelector("[data-netlify-identity-menu]");
          if (tabs) {
            tabs.style.display = "none";
          }

          modal.querySelectorAll("[data-netlify-identity-button]").forEach((button) => {
            const text = (button.textContent || "").toLowerCase();
            if (text.includes("sign up") || text.includes("signup") || text.includes("register")) {
              button.remove();
            }
          });

          const heading = modal.querySelector(".netlify-identity-title");
          if (heading) {
            heading.textContent = "Log in";
          }
        };

        window.netlifyIdentity.on("open", () => {
          cleanIdentityModal();
          const observer = new MutationObserver(() => cleanIdentityModal());
          const modal = document.querySelector(".netlify-identity-modal");
          if (modal) {
            observer.observe(modal, { childList: true, subtree: true });
          }
        });
      }

      function setupMobileShell() {
        const observer = new MutationObserver(() => applyMobileShell());
        observer.observe(document.body, { childList: true, subtree: true });
        applyMobileShell();
        window.addEventListener("hashchange", () => closeNav(), { passive: true });
      }

      function applyMobileShell() {
        const root = document.getElementById("nc-root");
        if (!root) return;

        root.classList.add("cms-mobile-root");
        ensureHeader(root);
        enhanceNav(root);
        simplifyContent(root);
      }

      function ensureHeader(root) {
        let header = document.getElementById("cms-mobile-header");
        if (!header) {
          header = document.createElement("header");
          header.id = "cms-mobile-header";
          header.className = "cms-mobile-header";
          header.innerHTML = `
            <button type="button" id="cms-nav-toggle" aria-expanded="false" aria-controls="cms-mobile-nav">
              <span class="cms-hamburger" aria-hidden="true"><span></span><span></span><span></span></span>
              Menu
            </button>
            <span class="cms-brand" aria-label="Admin home">TextMyLink Admin</span>
            <button type="button" id="cms-logout-button" class="cms-link-button">Log out</button>
          `;
          document.body.insertBefore(header, root);

          const toggle = header.querySelector("#cms-nav-toggle");
          toggle.addEventListener("click", () => {
            const open = !document.body.classList.contains("cms-nav-open");
            if (open) {
              document.body.classList.add("cms-nav-open");
            } else {
              document.body.classList.remove("cms-nav-open");
            }
            updateNavState();
          });

          const logout = header.querySelector("#cms-logout-button");
          logout.addEventListener("click", () => {
            if (window.netlifyIdentity) {
              window.netlifyIdentity.logout();
            }
          });
        }

        updateNavState();
      }

      function enhanceNav(root) {
        const nav =
          root.querySelector("[data-testid='collection-sidebar']") ||
          root.querySelector("nav[aria-label='Collections']") ||
          root.querySelector("aside[aria-label='Collections']");

        if (!nav) {
          return;
        }

        nav.id = "cms-mobile-nav";
        nav.classList.add("cms-mobile-nav");

        if (!nav.dataset.cmsMobileMoved) {
          root.insertBefore(nav, root.firstChild);
          nav.dataset.cmsMobileMoved = "true";
        }

        if (!nav.dataset.cmsMobileBound) {
          nav.dataset.cmsMobileBound = "true";
          nav.addEventListener("click", (event) => {
            if (event.target.closest("a, button")) {
              requestAnimationFrame(() => closeNav());
            }
          });
        }

        updateNavState();
      }

      function simplifyContent(root) {
        root
          .querySelectorAll("[data-testid='collection-content'], [data-testid='editor-pane'], main, [role='main']")
          .forEach((pane) => pane.classList.add("cms-mobile-pane"));

        root
          .querySelectorAll("[data-testid='entry-card'], [class*='EntryCard'], [class*='CollectionListCard']")
          .forEach((card) => card.classList.add("cms-condensed-card"));

        root.querySelectorAll("form").forEach((form) => {
          if (!form.dataset.cmsMobileBound) {
            form.dataset.cmsMobileBound = "true";
            form.addEventListener("submit", () => closeNav());
          }
        });
      }

      function updateNavState() {
        const open = document.body.classList.contains("cms-nav-open");
        const button = document.getElementById("cms-nav-toggle");
        if (button) {
          button.setAttribute("aria-expanded", open ? "true" : "false");
        }
        const nav = document.getElementById("cms-mobile-nav");
        if (nav) {
          nav.setAttribute("aria-hidden", open ? "false" : "true");
        }
      }

      function closeNav() {
        if (!document.body.classList.contains("cms-nav-open")) {
          updateNavState();
          return;
        }
        document.body.classList.remove("cms-nav-open");
        updateNavState();
      }
    </script>
  </body>
</html>
