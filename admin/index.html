<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TextMyLink Admin</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont,
          "Helvetica Neue", Arial, sans-serif;
        --shell-bg: #f1f5f9;
        --shell-surface: #ffffff;
        --shell-text: #0f172a;
        --shell-text-muted: #64748b;
        --shell-border: #e2e8f0;
        --shell-primary: #2563eb;
        --shell-primary-strong: #1d4ed8;
        --shell-header-height: 64px;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: inherit;
        background: var(--shell-bg);
        color: var(--shell-text);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      button {
        font: inherit;
        background: none;
        border: none;
        padding: 0;
      }

      #nc-root {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: calc(var(--shell-header-height) + env(safe-area-inset-top, 0px) +
            1rem)
          1rem calc(3.5rem + env(safe-area-inset-bottom, 0px));
      }

      #nc-root > * {
        max-width: 100%;
      }

      .cms-shell-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: calc(0.75rem + env(safe-area-inset-top, 0px)) 1rem 0.75rem;
        background: var(--shell-surface);
        border-bottom: 1px solid rgba(148, 163, 184, 0.24);
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      }

      .cms-shell-menu {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        border: 1px solid var(--shell-border);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--shell-text);
        background: var(--shell-surface);
        cursor: pointer;
      }

      .cms-shell-menu::before {
        content: "";
        width: 18px;
        height: 2px;
        background: currentColor;
        border-radius: 999px;
        box-shadow: 0 6px 0 currentColor, 0 -6px 0 currentColor;
      }

      .cms-shell-title {
        flex: 1 1 auto;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
      }

      .cms-shell-title__eyebrow {
        font-size: 0.7rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: var(--shell-text-muted);
        font-weight: 600;
      }

      .cms-shell-title__route {
        font-size: 1.05rem;
        font-weight: 600;
        color: var(--shell-text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .cms-shell-primary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
        padding: 0.6rem 1.1rem;
        border-radius: 999px;
        background: var(--shell-primary);
        color: #fff;
        font-weight: 600;
        font-size: 0.95rem;
        transition: background 0.2s ease;
      }

      .cms-shell-primary:active {
        background: var(--shell-primary-strong);
      }

      .cms-shell-primary[hidden] {
        display: none !important;
      }

      body.cms-shell-editing .cms-shell-primary {
        display: none !important;
      }

      #cms-shell-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        z-index: 900;
        display: none;
      }

      body.cms-shell-drawer-open {
        overflow: hidden;
      }

      body.cms-shell-drawer-open #cms-shell-overlay {
        display: block;
      }

      #cms-shell-drawer {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: min(85vw, 320px);
        background: var(--shell-surface);
        padding: calc(1rem + env(safe-area-inset-top, 0px)) 1rem
          calc(1.25rem + env(safe-area-inset-bottom, 0px));
        box-shadow: 24px 0 48px rgba(15, 23, 42, 0.18);
        transform: translateX(-100%);
        transition: transform 0.25s ease;
        z-index: 950;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        overflow-y: auto;
      }

      body.cms-shell-drawer-open #cms-shell-drawer {
        transform: translateX(0);
      }

      #cms-shell-drawer[aria-hidden="true"] {
        pointer-events: none;
      }

      .cms-shell-drawer__sections {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .cms-shell-drawer__section {
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
      }

      .cms-shell-drawer__section[hidden] {
        display: none !important;
      }

      .cms-shell-drawer__top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .cms-shell-drawer__title {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
      }

      .cms-shell-drawer__title span {
        font-size: 0.7rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: var(--shell-text-muted);
        font-weight: 600;
      }

      .cms-shell-drawer__title strong {
        font-size: 1.1rem;
        font-weight: 700;
      }

      .cms-shell-drawer__close {
        color: var(--shell-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.35rem 0.6rem;
        border-radius: 8px;
        border: 1px solid transparent;
        cursor: pointer;
      }

      .cms-shell-drawer__close:active {
        color: var(--shell-text);
      }

      .cms-shell-drawer__heading {
        margin: 0;
        font-size: 0.75rem;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--shell-text-muted);
        font-weight: 600;
      }

      .cms-shell-drawer__stack {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .cms-shell-drawer__stack > * {
        width: 100% !important;
        max-width: 100% !important;
      }

      .cms-shell-drawer__stack[data-cms-shell-nav] nav,
      .cms-shell-drawer__stack[data-cms-shell-nav] ul {
        margin: 0;
        padding: 0;
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
      }

      .cms-shell-drawer__stack[data-cms-shell-nav] a,
      .cms-shell-drawer__stack[data-cms-shell-nav] button {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.4rem;
        padding: 0.7rem 0.85rem;
        border-radius: 12px;
        background: #f8fafc;
        border: 1px solid rgba(148, 163, 184, 0.16);
        font-weight: 600;
        font-size: 0.95rem;
      }

      .cms-shell-drawer__stack[data-cms-shell-nav] a:hover,
      .cms-shell-drawer__stack[data-cms-shell-nav] button:hover {
        background: #e0ecff;
      }

      .cms-shell-drawer__stack[data-cms-shell-tools] > *,
      .cms-shell-drawer__stack[data-cms-shell-workflow] > * {
        background: #f8fafc;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.18);
        padding: 0.75rem;
      }

      .cms-shell-drawer__stack[data-cms-shell-tools] button,
      .cms-shell-drawer__stack[data-cms-shell-tools] a,
      .cms-shell-drawer__stack[data-cms-shell-workflow] button,
      .cms-shell-drawer__stack[data-cms-shell-workflow] a {
        width: 100% !important;
      }

      .cms-shell-drawer__panel {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
      }

      .cms-shell-drawer__panel > * {
        width: 100% !important;
      }

      .cms-shell-drawer__panel input,
      .cms-shell-drawer__panel select,
      .cms-shell-drawer__panel textarea {
        width: 100% !important;
        font-size: 0.95rem !important;
        border-radius: 12px !important;
        border: 1px solid var(--shell-border) !important;
        padding: 0.65rem 0.75rem !important;
      }

      .cms-shell-drawer__panel button,
      .cms-shell-drawer__panel a {
        width: 100% !important;
      }

      .cms-shell-empty {
        margin: 0;
        font-size: 0.9rem;
        color: var(--shell-text-muted);
      }

      body.cms-shell-mobile [data-cms-shell-nav-source] {
        display: none !important;
      }

      body.cms-shell-mobile #nc-root header[role="banner"],
      body.cms-shell-mobile #nc-root header[role="toolbar"],
      body.cms-shell-mobile #nc-root nav[role="navigation"],
      body.cms-shell-mobile #nc-root aside,
      body.cms-shell-mobile #nc-root [class*="AppHeader"],
      body.cms-shell-mobile #nc-root [class*="CollectionTop"],
      body.cms-shell-mobile #nc-root [class*="CollectionControls"],
      body.cms-shell-mobile #nc-root [class*="Workflow"],
      body.cms-shell-mobile #nc-root [class*="Sidebar"],
      body.cms-shell-mobile #nc-root [class*="Toolbar"] {
        display: none !important;
      }

      body.cms-shell-mobile #nc-root button,
      body.cms-shell-mobile #nc-root .nc-button,
      body.cms-shell-mobile #nc-root [class*="Button"],
      body.cms-shell-mobile #nc-root [role="toolbar"] a {
        border-radius: 12px !important;
        font-size: 0.95rem !important;
        min-height: 44px !important;
      }

      body.cms-shell-mobile #nc-root .nc-entryListingCard,
      body.cms-shell-mobile #nc-root [class*="Card"],
      body.cms-shell-mobile #nc-root [class*="Pane"],
      body.cms-shell-mobile #nc-root [class*="Workflow"] {
        border-radius: 18px !important;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.12) !important;
        border: 1px solid rgba(148, 163, 184, 0.14) !important;
        background: var(--shell-surface) !important;
      }

      body.cms-shell-mobile #nc-root label,
      body.cms-shell-mobile #nc-root .nc-controlPane-label,
      body.cms-shell-mobile #nc-root [class*="Label"] {
        font-weight: 600 !important;
        font-size: 0.95rem !important;
        color: var(--shell-text) !important;
      }

      body.cms-shell-mobile #nc-root input,
      body.cms-shell-mobile #nc-root textarea,
      body.cms-shell-mobile #nc-root select {
        font-size: 1rem !important;
        padding: 0.75rem !important;
        border-radius: 12px !important;
        border: 1px solid var(--shell-border) !important;
        box-shadow: none !important;
      }

      body.cms-shell-mobile #nc-root table {
        width: 100%;
        display: block;
        border-collapse: collapse;
        background: transparent;
      }

      body.cms-shell-mobile #nc-root thead {
        display: none !important;
      }

      body.cms-shell-mobile #nc-root tbody {
        display: grid;
        gap: 0.75rem;
        padding: 0;
        margin: 0;
      }

      body.cms-shell-mobile #nc-root tbody tr {
        display: grid;
        gap: 0.5rem;
        padding: 0.9rem 1rem;
        border-radius: 16px;
        background: var(--shell-surface);
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.1);
        border: 1px solid rgba(148, 163, 184, 0.18);
      }

      body.cms-shell-mobile #nc-root td {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        font-size: 0.95rem;
      }

      body.cms-shell-mobile #nc-root td::before {
        content: attr(data-header);
        font-size: 0.7rem;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: var(--shell-text-muted);
        font-weight: 600;
      }

      @media (min-width: 960px) {
        :root {
          --shell-header-height: 72px;
        }

        #nc-root {
          padding: calc(var(--shell-header-height) + 1.5rem) 3rem 3rem;
          max-width: 1100px;
          margin: 0 auto;
        }

        .cms-shell-header {
          position: sticky;
          top: 0;
          padding: 1rem 3rem;
          box-shadow: none;
        }

        .cms-shell-menu {
          display: none;
        }

        #cms-shell-overlay {
          display: none !important;
        }

        #cms-shell-drawer {
          width: 320px;
          border-radius: 16px;
          border: 1px solid var(--shell-border);
          box-shadow: 0 18px 38px rgba(15, 23, 42, 0.12);
        }

        body.cms-shell-drawer-open {
          overflow: auto;
        }
      }
    </style>
  </head>
  <body>
    <header id="cms-shell-header" class="cms-shell-header" role="banner">
      <button
        id="cms-shell-menu"
        class="cms-shell-menu"
        type="button"
        aria-label="Open collections menu"
        aria-expanded="false"
      ></button>
      <div class="cms-shell-title">
        <span class="cms-shell-title__eyebrow">TextMyLink</span>
        <span id="cms-shell-route" class="cms-shell-title__route">Admin</span>
      </div>
      <a id="cms-shell-primary" class="cms-shell-primary" href="#" hidden>
        New Entry
      </a>
    </header>
    <div id="cms-shell-overlay" hidden></div>
    <aside
      id="cms-shell-drawer"
      aria-hidden="true"
      role="navigation"
      aria-label="Collections navigation"
    >
      <div class="cms-shell-drawer__top">
        <div class="cms-shell-drawer__title">
          <span>TextMyLink</span>
          <strong>Collections</strong>
        </div>
        <button
          id="cms-shell-drawer-close"
          class="cms-shell-drawer__close"
          type="button"
        >
          Close
        </button>
      </div>
      <div class="cms-shell-drawer__sections">
        <section
          class="cms-shell-drawer__section"
          data-cms-shell-section="nav"
        >
          <h2 class="cms-shell-drawer__heading">Browse</h2>
          <div class="cms-shell-drawer__stack" data-cms-shell-nav>
            <p class="cms-shell-empty">Collections load once ready.</p>
          </div>
        </section>
        <section
          class="cms-shell-drawer__section"
          data-cms-shell-section="tools"
          hidden
        >
          <h2 class="cms-shell-drawer__heading">Tools</h2>
          <div class="cms-shell-drawer__stack" data-cms-shell-tools></div>
        </section>
        <section
          class="cms-shell-drawer__section"
          data-cms-shell-section="workflow"
          hidden
        >
          <h2 class="cms-shell-drawer__heading">Workflow</h2>
          <div
            class="cms-shell-drawer__stack"
            data-cms-shell-workflow
          ></div>
        </section>
      </div>
    </aside>
    <div id="nc-root"></div>

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
      window.process = window.process || { env: { NODE_ENV: "production" } };
      window.CMS_MANUAL_INIT = true;
    </script>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      let cmsHasStarted = false;

      function startCms() {
        if (cmsHasStarted) {
          return;
        }

        const tryInit = () => {
          if (window.CMS && typeof window.CMS.init === "function") {
            window.CMS.init();
            setupMobileShell();
            return true;
          }
          if (
            window.NetlifyCmsApp &&
            typeof window.NetlifyCmsApp.init === "function"
          ) {
            window.NetlifyCmsApp.init();
            setupMobileShell();
            return true;
          }
          return false;
        };

        if (tryInit()) {
          cmsHasStarted = true;
          return;
        }

        const message =
          "Decap CMS failed to load. Check the console for details.";
        console.error(message);
        document.body.insertAdjacentHTML("beforeend", `<p>${message}</p>`);
      }

      function enforceAuthentication() {
        if (!window.netlifyIdentity) {
          if (enforceAuthentication.retryCount > 20) {
            console.error(
              "Netlify Identity failed to load. The CMS cannot start."
            );
            return;
          }
          enforceAuthentication.retryCount =
            (enforceAuthentication.retryCount || 0) + 1;
          setTimeout(enforceAuthentication, 100);
          return;
        }

        if (enforceAuthentication.initialized) {
          return;
        }
        enforceAuthentication.initialized = true;

        const identity = window.netlifyIdentity;
        let loginModalOpen = false;

        const requireLogin = () => {
          if (identity.currentUser() || loginModalOpen) {
            return;
          }
          identity.open("login");
        };

        identity.on("init", (user) => {
          if (user) {
            startCms();
          } else {
            setTimeout(() => requireLogin(), 0);
          }
        });

        identity.on("open", () => {
          loginModalOpen = true;
        });

        identity.on("login", () => {
          startCms();
          identity.close();
        });

        identity.on("logout", () => {
          cmsHasStarted = false;
          document.location.href = "/admin/";
        });

        identity.on("close", () => {
          loginModalOpen = false;
          if (!identity.currentUser()) {
            setTimeout(() => requireLogin(), 0);
          }
        });

        identity.init();
      }

      function setupIdentityUI() {
        if (setupIdentityUI.initialized) {
          return;
        }

        if (!window.netlifyIdentity) {
          if (setupIdentityUI.retryCount > 20) {
            return;
          }
          setupIdentityUI.retryCount = (setupIdentityUI.retryCount || 0) + 1;
          setTimeout(setupIdentityUI, 100);
          return;
        }

        setupIdentityUI.initialized = true;

        const simplifyModal = () => {
          const modal = document.querySelector(".netlify-identity-modal");
          if (!modal) return;

          const tabs = modal.querySelector("[data-netlify-identity-menu]");
          if (tabs) {
            tabs.style.display = "none";
          }

          const content = modal.querySelector(".netlify-identity-modal-pane");
          if (content) {
            content.style.padding = "1.5rem 1.5rem 2rem";
          }

          const heading = modal.querySelector(".netlify-identity-form h2");
          if (heading) {
            heading.textContent = "Sign in to edit";
          }

          const switchers = modal.querySelectorAll(
            ".netlify-identity-form .netlify-identity-link"
          );
          switchers.forEach((link) => {
            link.style.display = "none";
          });
        };

        const observer = new MutationObserver(simplifyModal);
        observer.observe(document.body, {
          childList: true,
          subtree: true,
        });
        simplifyModal();
      }

      function setupMobileShell() {
        if (setupMobileShell.initialized) {
          return;
        }
        setupMobileShell.initialized = true;

        const state = {
          header: document.getElementById("cms-shell-header"),
          menu: document.getElementById("cms-shell-menu"),
          overlay: document.getElementById("cms-shell-overlay"),
          drawer: document.getElementById("cms-shell-drawer"),
          drawerClose: document.getElementById("cms-shell-drawer-close"),
          route: document.getElementById("cms-shell-route"),
          primary: document.getElementById("cms-shell-primary"),
          navContainer: document.querySelector("[data-cms-shell-nav]"),
          toolsContainer: document.querySelector("[data-cms-shell-tools]"),
          workflowContainer: document.querySelector(
            "[data-cms-shell-workflow]"
          ),
          sections: {
            tools: document.querySelector(
              "[data-cms-shell-section='tools']"
            ),
            workflow: document.querySelector(
              "[data-cms-shell-section='workflow']"
            ),
          },
        };

        const MOBILE_QUERY = window.matchMedia("(max-width: 960px)");
        let observer = null;
        let scheduled = false;
        const panelMirrors = new Map();
        const PANEL_CONFIGS = [
          { selector: "[class*='AppHeader']", slot: "tools" },
          { selector: "[class*='CollectionTop']", slot: "tools" },
          { selector: "[class*='CollectionControls']", slot: "tools" },
          { selector: "[class*='Workflow']", slot: "workflow" },
        ];
        const SLOT_FALLBACKS = {
          tools: "Tools appear once a collection is selected.",
          workflow: "Workflow appears after entries are created.",
        };


        const scheduleApply = () => {
          if (scheduled) return;
          scheduled = true;
          requestAnimationFrame(applyShellState);
        };

        const updateHeaderOffset = () => {
          if (!state.header) {
            return;
          }
          const height = Math.ceil(
            state.header.getBoundingClientRect().height
          );
          document.documentElement.style.setProperty(
            "--shell-header-height",
            `${height}px`
          );
        };

        const applyShellState = () => {
          scheduled = false;
          const root = document.getElementById("nc-root");
          if (!root) {
            return;
          }

          updateHeaderOffset();

          const isMobile = MOBILE_QUERY.matches;
          document.body.classList.toggle("cms-shell-mobile", isMobile);

          if (!isMobile) {
            closeDrawer();
            resetTables(root);
            document.body.classList.remove("cms-shell-editing");
            clearMirrors();
            return;
          }

          if (!state.navContainer && state.drawer) {
            state.navContainer = state.drawer.querySelector(
              "[data-cms-shell-nav]"
            );
          }

          bindMenu();
          mirrorPanels(root);
          syncNavigation(root);
          updateRouteLabel();
          updatePrimaryButton();
          updateEditingState();
          adaptTables(root);
        };

        const bindMenu = () => {
          if (state.menu && state.menu.dataset.bound !== "true") {
            state.menu.addEventListener("click", () => toggleDrawer());
            state.menu.dataset.bound = "true";
          }

          if (state.overlay && state.overlay.dataset.bound !== "true") {
            state.overlay.addEventListener("click", () => toggleDrawer(false));
            state.overlay.dataset.bound = "true";
          }

          if (state.drawer && state.drawer.dataset.bound !== "true") {
            state.drawer.addEventListener("click", (event) => {
              if (event.target.closest("a, button")) {
                toggleDrawer(false);
              }
            });
            state.drawer.dataset.bound = "true";
          }

          if (state.drawerClose && state.drawerClose.dataset.bound !== "true") {
            state.drawerClose.addEventListener("click", () => toggleDrawer(false));
            state.drawerClose.dataset.bound = "true";
          }
        };

        const toggleDrawer = (force) => {
          const shouldOpen =
            typeof force === "boolean"
              ? force
              : !document.body.classList.contains("cms-shell-drawer-open");

          document.body.classList.toggle("cms-shell-drawer-open", shouldOpen);

          if (state.overlay) {
            state.overlay.hidden = !shouldOpen;
          }

          if (state.drawer) {
            state.drawer.setAttribute(
              "aria-hidden",
              shouldOpen ? "false" : "true"
            );
          }

          if (state.menu) {
            state.menu.setAttribute(
              "aria-expanded",
              shouldOpen ? "true" : "false"
            );
            state.menu.setAttribute(
              "aria-label",
              shouldOpen
                ? "Close collections menu"
                : "Open collections menu"
            );
          }
        };

        const closeDrawer = () => toggleDrawer(false);

        const mirrorInteractive = (cloneEl, originalEl, cleanup) => {
          if (!cloneEl || !originalEl) {
            if (cloneEl) {
              cloneEl.setAttribute("disabled", "true");
            }
            return;
          }

          const tagName = (cloneEl.tagName || "").toLowerCase();
          const type = (cloneEl.type || "").toLowerCase();

          if (tagName === "select") {
            cloneEl.value = originalEl.value;
            const syncFromOriginal = () => {
              cloneEl.value = originalEl.value;
            };
            const syncToOriginal = () => {
              originalEl.value = cloneEl.value;
              originalEl.dispatchEvent(
                new Event("change", { bubbles: true })
              );
            };
            cloneEl.addEventListener("change", syncToOriginal);
            originalEl.addEventListener("change", syncFromOriginal);
            cleanup.push(() =>
              originalEl.removeEventListener("change", syncFromOriginal)
            );
          } else if (tagName === "input" || tagName === "textarea") {
            if (type === "checkbox" || type === "radio") {
              cloneEl.checked = originalEl.checked;
              const syncFromOriginal = () => {
                cloneEl.checked = originalEl.checked;
              };
              const syncToOriginal = () => {
                originalEl.checked = cloneEl.checked;
                originalEl.dispatchEvent(
                  new Event("change", { bubbles: true })
                );
              };
              cloneEl.addEventListener("change", syncToOriginal);
              originalEl.addEventListener("change", syncFromOriginal);
              cleanup.push(() =>
                originalEl.removeEventListener("change", syncFromOriginal)
              );
            } else {
              cloneEl.value = originalEl.value;
              const syncFromOriginal = () => {
                cloneEl.value = originalEl.value;
              };
              const syncToOriginal = () => {
                originalEl.value = cloneEl.value;
                const eventType = type === "search" ? "search" : "input";
                originalEl.dispatchEvent(
                  new Event(eventType, { bubbles: true })
                );
              };
              cloneEl.addEventListener("input", syncToOriginal);
              originalEl.addEventListener("input", syncFromOriginal);
              cleanup.push(() =>
                originalEl.removeEventListener("input", syncFromOriginal)
              );
            }
          } else {
            cloneEl.addEventListener("click", (event) => {
              event.preventDefault();
              event.stopPropagation();
              originalEl.dispatchEvent(
                new MouseEvent("click", { bubbles: true, cancelable: true })
              );
            });
          }
        };

        const ensureSlotFallback = (slot, text) => {
          if (!slot) {
            return;
          }
          const hasPanel = slot.querySelector(
            ".cms-shell-drawer__panel"
          );
          let message = slot.querySelector(
            "[data-cms-shell-empty-message]"
          );
          if (!hasPanel && text) {
            if (!message) {
              message = document.createElement("p");
              message.className = "cms-shell-empty";
              message.dataset.cmsShellEmptyMessage = "true";
              message.textContent = text;
              slot.appendChild(message);
            } else {
              message.textContent = text;
            }
          } else if (message && hasPanel) {
            message.remove();
          }
        };

        const updateDrawerSections = () => {
          if (state.sections && state.sections.tools) {
            const hasTools = !!state.toolsContainer?.querySelector(
              ".cms-shell-drawer__panel"
            );
            state.sections.tools.hidden = !hasTools;
          }
          if (state.sections && state.sections.workflow) {
            const hasWorkflow = !!state.workflowContainer?.querySelector(
              ".cms-shell-drawer__panel"
            );
            state.sections.workflow.hidden = !hasWorkflow;
          }
        };

        const clearMirrors = () => {
          panelMirrors.forEach((record) => {
            record.cleanup.forEach((fn) => fn());
            if (record.wrapper && record.wrapper.parentNode) {
              record.wrapper.parentNode.removeChild(record.wrapper);
            }
          });
          panelMirrors.clear();
          if (state.toolsContainer) {
            state.toolsContainer.innerHTML = "";
          }
          if (state.workflowContainer) {
            state.workflowContainer.innerHTML = "";
          }
          ensureSlotFallback(state.toolsContainer, SLOT_FALLBACKS.tools);
          ensureSlotFallback(
            state.workflowContainer,
            SLOT_FALLBACKS.workflow
          );
          updateDrawerSections();
        };

        const mirrorPanel = (selector, original, slot) => {
          if (!slot) {
            return;
          }

          let record = panelMirrors.get(selector);

          if (!original) {
            if (record) {
              record.cleanup.forEach((fn) => fn());
              if (record.wrapper && record.wrapper.parentNode) {
                record.wrapper.parentNode.removeChild(record.wrapper);
              }
              panelMirrors.delete(selector);
            }
            return;
          }

          if (!record) {
            const wrapper = document.createElement("div");
            wrapper.className = "cms-shell-drawer__panel";
            slot.appendChild(wrapper);
            record = { cleanup: [], wrapper };
            panelMirrors.set(selector, record);
          }

          const wrapper = record.wrapper;
          record.cleanup.forEach((fn) => fn());
          record.cleanup = [];

          const clone = original.cloneNode(true);
          clone.removeAttribute("id");
          clone
            .querySelectorAll("[id]")
            .forEach((node) => node.removeAttribute("id"));

          wrapper.innerHTML = "";
          wrapper.appendChild(clone);

          const originalInteractives = Array.from(
            original.querySelectorAll("a, button, input, select, textarea")
          );
          const cloneInteractives = Array.from(
            clone.querySelectorAll("a, button, input, select, textarea")
          );

          cloneInteractives.forEach((element, index) => {
            mirrorInteractive(element, originalInteractives[index], record.cleanup);
          });
        };

        const mirrorPanels = (root) => {
          PANEL_CONFIGS.forEach((config) => {
            const slot =
              config.slot === "tools"
                ? state.toolsContainer
                : config.slot === "workflow"
                ? state.workflowContainer
                : null;
            const original = root.querySelector(config.selector);
            mirrorPanel(config.selector, original, slot);
          });

          ensureSlotFallback(state.toolsContainer, SLOT_FALLBACKS.tools);
          ensureSlotFallback(
            state.workflowContainer,
            SLOT_FALLBACKS.workflow
          );
          updateDrawerSections();
        };

        const syncNavigation = (root) => {
          if (!state.navContainer) {
            return;
          }

          const sourceNav = findSidebar(root);
          if (!sourceNav) {
            state.navContainer.innerHTML =
              '<p class="cms-shell-empty">Collections load once ready.</p>';
            return;
          }

          sourceNav.dataset.cmsShellNavSource = "true";

          const clone = sourceNav.cloneNode(true);
          clone.removeAttribute("id");
          Array.from(clone.querySelectorAll("[id]"))
            .filter((el) => el.id)
            .forEach((el) => el.removeAttribute("id"));

          state.navContainer.innerHTML = "";
          state.navContainer.appendChild(clone);
        };

        const updateRouteLabel = () => {
          if (!state.route) {
            return;
          }
          state.route.textContent = describeRoute();
        };

        const updatePrimaryButton = () => {
          if (!state.primary) {
            return;
          }

          if (isAuthRoute() || isEditorRoute()) {
            state.primary.hidden = true;
            return;
          }

          const collection = getDefaultCollectionName();
          if (!collection) {
            state.primary.hidden = true;
            return;
          }

          const label = formatCollectionLabel(collection);
          const target = `#/collections/${encodeURIComponent(collection)}/new`;
          state.primary.textContent = `New ${label}`;
          state.primary.href = target;
          state.primary.hidden = false;
          state.primary.onclick = (event) => {
            event.preventDefault();
            window.location.hash = target;
            closeDrawer();
          };
        };

        const updateEditingState = () => {
          const editing = isEditorRoute();
          document.body.classList.toggle("cms-shell-editing", editing);
        };

        const adaptTables = (root) => {
          root.querySelectorAll("table").forEach((table) => {
            const headerCells = Array.from(
              table.querySelectorAll("thead th")
            ).map((cell) => cell.textContent.trim());
            if (headerCells.length === 0) {
              return;
            }
            table.querySelectorAll("tbody tr").forEach((row) => {
              row.querySelectorAll("td").forEach((cell, index) => {
                if (headerCells[index]) {
                  cell.dataset.header = headerCells[index];
                }
              });
            });
            table.dataset.cmsShellStacked = "true";
          });
        };

        const resetTables = (root) => {
          root
            .querySelectorAll("table[data-cms-shell-stacked='true']")
            .forEach((table) => {
              table.removeAttribute("data-cms-shell-stacked");
              table
                .querySelectorAll("td[data-header]")
                .forEach((cell) => cell.removeAttribute("data-header"));
            });
        };

        MOBILE_QUERY.addEventListener("change", scheduleApply);
        window.addEventListener("hashchange", scheduleApply);
        window.addEventListener("resize", () => {
          updateHeaderOffset();
          scheduleApply();
        });

        const watchRoot = () => {
          const root = document.getElementById("nc-root");
          if (!root) {
            setTimeout(watchRoot, 200);
            return;
          }

          if (observer) {
            observer.disconnect();
          }

          observer = new MutationObserver(scheduleApply);
          observer.observe(root, { childList: true, subtree: true });
          scheduleApply();
        };

        ensureSlotFallback(state.toolsContainer, SLOT_FALLBACKS.tools);
        ensureSlotFallback(
          state.workflowContainer,
          SLOT_FALLBACKS.workflow
        );

        watchRoot();
        scheduleApply();
      }

      function formatCollectionLabel(name) {
        if (!name) return "Entry";
        return decodeURIComponent(name)
          .replace(/[-_]+/g, " ")
          .replace(/\b\w/g, (char) => char.toUpperCase());
      }

      function describeRoute() {
        const hash = window.location.hash || "";
        if (!hash || hash === "#/" || hash === "#") {
          return "Dashboard";
        }
        if (/^#\/workflow/.test(hash)) {
          return "Workflow";
        }
        const newMatch = hash.match(/^#\/collections\/([^/]+)\/new/);
        if (newMatch && newMatch[1]) {
          return `New ${formatCollectionLabel(newMatch[1])}`;
        }
        const editMatch = hash.match(/^#\/collections\/([^/]+)\/entries/);
        if (editMatch && editMatch[1]) {
          return `Editing ${formatCollectionLabel(editMatch[1])}`;
        }
        const collectionMatch = hash.match(/^#\/collections\/([^/]+)/);
        if (collectionMatch && collectionMatch[1]) {
          return `${formatCollectionLabel(collectionMatch[1])} Entries`;
        }
        return "Admin";
      }

      function isAuthRoute() {
        const hash = (window.location.hash || "").toLowerCase();
        if (!hash || hash === "#/" || hash === "#") {
          return false;
        }
        return (
          hash.startsWith("#/login") ||
          hash.startsWith("#/recover") ||
          hash.startsWith("#/forgot") ||
          hash.startsWith("#/invite")
        );
      }

      function isEditorRoute() {
        const hash = window.location.hash || "";
        return /#\/collections\/[^/]+\/(entries|new)/.test(hash);
      }

      function findSidebar(root) {
        if (!root) return null;
        const candidates = root.querySelectorAll("[role='navigation'], aside");
        for (const element of candidates) {
          const text = (element.textContent || "").toLowerCase();
          if (text.includes("collections")) {
            return element;
          }
        }
        return candidates[0] || null;
      }

      function getDefaultCollectionName() {
        const hash = window.location.hash || "";
        const hashMatch = hash.match(/#\/collections\/([^/]+)/);
        if (hashMatch && hashMatch[1]) {
          return decodeURIComponent(hashMatch[1]);
        }

        try {
          const cms = window.CMS;
          if (cms && typeof cms.getCollections === "function") {
            const collections = cms.getCollections();
            if (collections && typeof collections.valueSeq === "function") {
              const first = collections
                .valueSeq()
                .find(
                  (collection) =>
                    collection &&
                    collection.get &&
                    collection.get("create") !== false
                );
              if (first && typeof first.get === "function") {
                return first.get("name");
              }
            }
          }
        } catch (error) {
          console.warn("Unable to derive collection from CMS state:", error);
        }

        try {
          const globalConfig =
            window.__DECAP_CMS_INITIAL_STATE__?.config ||
            window.__NETLIFY_CMS_DATA__?.config ||
            null;
          if (
            globalConfig &&
            Array.isArray(globalConfig.collections) &&
            globalConfig.collections.length > 0
          ) {
            const firstWritable = globalConfig.collections.find(
              (collection) => collection && collection.create !== false
            );
            if (firstWritable && firstWritable.name) {
              return firstWritable.name;
            }
          }
        } catch (error) {
          console.warn("Unable to derive collection from global config:", error);
        }

        return "blog";
      }

      enforceAuthentication();
      setupIdentityUI();
    </script>
  </body>
</html>
