<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TextMyLink CMS</title>
    <style>
      :root {
        color-scheme: light;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      body {
        margin: 0;
        background: #f1f5f9;
        color: #0f172a;
      }
      body.cms-nav-open {
        overflow: hidden;
      }
      body.cms-collections-open {
        overflow: hidden;
      }
      #cms-mobile-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: #0f172a;
        color: #f8fafc;
      }
      #cms-mobile-header button {
        background: none;
        border: none;
        color: inherit;
        font: inherit;
        cursor: pointer;
      }
      #cms-mobile-header button:focus-visible {
        outline: 2px solid #38bdf8;
        outline-offset: 2px;
      }
      #cms-mobile-header .cms-brand {
        font-weight: 600;
        font-size: 1.05rem;
      }
      #cms-nav-toggle,
      #cms-collections-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.5rem;
        border-radius: 0.5rem;
      }
      #cms-nav-toggle .cms-hamburger {
        display: inline-flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      #cms-nav-toggle .cms-hamburger span {
        display: block;
        width: 1.3rem;
        height: 0.14rem;
        background: currentColor;
        border-radius: 1rem;
      }
      body.cms-nav-open #cms-nav-toggle,
      body.cms-collections-open #cms-collections-toggle {
        color: #38bdf8;
      }
      #cms-logout-button {
        margin-left: auto;
        padding: 0.35rem 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid rgba(255, 255, 255, 0.35);
      }
      #cms-logout-button:hover {
        background: rgba(255, 255, 255, 0.12);
      }
      #nc-root.cms-mobile-root {
        min-height: calc(100vh - 3.5rem);
        display: flex;
        flex-direction: column;
      }
      #nc-root.cms-mobile-root .nc-app,
      #nc-root.cms-mobile-root [data-testid="app-container"],
      #nc-root.cms-mobile-root [class*="AppLayout"] {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
      }
      #nc-root.cms-mobile-root .nc-app-header,
      #nc-root.cms-mobile-root [class*="AppHeader"],
      #nc-root.cms-mobile-root header[role="banner"] {
        display: none !important;
      }
      #cms-mobile-nav-container {
        display: none;
        border-bottom: 1px solid #cbd5f5;
        background: #e2e8f0;
        padding: 0.5rem 1rem;
        box-sizing: border-box;
        width: 100%;
      }
      #cms-mobile-nav-container[hidden] {
        display: none !important;
      }
      #cms-mobile-nav-container .cms-mobile-nav {
        display: none;
      }
      body.cms-nav-open #cms-mobile-nav-container .cms-mobile-nav,
      body.cms-collections-open #cms-mobile-nav-container .cms-mobile-nav {
        display: block;
      }
      #cms-mobile-nav-container .cms-mobile-nav,
      #cms-mobile-nav-container [data-testid="collection-sidebar"],
      #cms-mobile-nav-container nav[aria-label="Collections"],
      #cms-mobile-nav-container aside[aria-label="Collections"] {
        width: 100% !important;
        max-width: none !important;
        border: none !important;
        background: transparent !important;
        padding: 0 !important;
        box-sizing: border-box;
        display: block;
        position: static !important;
        inset: auto !important;
        height: auto !important;
        box-shadow: none !important;
        z-index: auto !important;
        transform: none !important;
      }
      #cms-mobile-nav-container .cms-mobile-nav > * {
        margin: 0 !important;
      }
      #cms-mobile-nav-container .cms-mobile-nav * {
        box-shadow: none !important;
      }
      #cms-mobile-nav-container .cms-mobile-nav div[role="presentation"],
      #cms-mobile-nav-container .cms-mobile-nav div[role="presentation"] > *,
      #cms-mobile-nav-container .cms-mobile-nav [class*="MuiDrawer"],
      #cms-mobile-nav-container .cms-mobile-nav [class*="MuiPaper"],
      #cms-mobile-nav-container .cms-mobile-nav [class*="MuiModal"],
      #cms-mobile-nav-container .cms-mobile-nav [class*="MuiBackdrop"] {
        position: static !important;
        inset: auto !important;
        transform: none !important;
        height: auto !important;
        width: 100% !important;
        max-width: none !important;
        border-radius: 0 !important;
        background: transparent !important;
        box-shadow: none !important;
        opacity: 1 !important;
      }
      #cms-mobile-nav-container .cms-mobile-nav [class*="MuiBackdrop"] {
        display: none !important;
      }
      #cms-mobile-nav-container .cms-mobile-nav [class*="MuiPaper"] > * {
        background: transparent !important;
      }
      #cms-mobile-nav-container .cms-mobile-nav ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      #cms-mobile-nav-container .cms-mobile-nav a {
        display: block;
        padding: 0.55rem 0.65rem;
        border-radius: 0.5rem;
        color: #0f172a;
        text-decoration: none;
        font-weight: 500;
      }
      #cms-mobile-nav-container .cms-mobile-nav a:hover {
        background: #cbd5f5;
      }
      #nc-root.cms-mobile-root .cms-mobile-pane,
      #nc-root.cms-mobile-root [data-testid="collection-content"],
      #nc-root.cms-mobile-root [data-testid="editor-pane"],
      #nc-root.cms-mobile-root main,
      #nc-root.cms-mobile-root [role="main"] {
        flex: 1 1 auto;
        padding: 1rem;
        min-height: 0;
        overflow: auto;
      }
      #nc-root.cms-mobile-root form {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      #nc-root.cms-mobile-root input,
      #nc-root.cms-mobile-root select,
      #nc-root.cms-mobile-root textarea {
        font: inherit;
        padding: 0.6rem 0.75rem;
        border: 1px solid #cbd5f5;
        border-radius: 0.5rem;
        width: 100%;
        box-sizing: border-box;
        background: #fff;
      }
      #nc-root.cms-mobile-root [data-testid="entry-card"],
      #nc-root.cms-mobile-root [class*="EntryCard"],
      #nc-root.cms-mobile-root [class*="CollectionListCard"] {
        padding: 0.75rem;
        border-radius: 0.75rem;
        border: 1px solid #cbd5f5;
        background: #fff;
        margin-bottom: 0.75rem;
      }
      #nc-root.cms-mobile-root table {
        width: 100%;
        border-collapse: collapse;
      }
      #nc-root.cms-mobile-root th,
      #nc-root.cms-mobile-root td {
        padding: 0.5rem;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
      }
      @media (min-width: 900px) {
        #nc-root.cms-mobile-root {
          margin: 0 auto;
          max-width: 960px;
        }
      }
    </style>
  </head>
  <body>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", function (user) {
          if (!user) {
            window.netlifyIdentity.on("login", function () {
              document.location.href = "/admin/";
            });
          }
        });
      }
    </script>
    <script>
      window.process = window.process || { env: { NODE_ENV: "production" } };
      window.CMS_MANUAL_INIT = true;
    </script>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      (function initCms() {
        if (window.CMS && typeof window.CMS.init === "function") {
          window.CMS.init();
          setupIdentityUI();
          setupMobileShell();
          return;
        }
        if (window.NetlifyCmsApp && typeof window.NetlifyCmsApp.init === "function") {
          window.NetlifyCmsApp.init();
          setupIdentityUI();
          setupMobileShell();
          return;
        }
        const message = "Netlify CMS failed to load. Check the browser console for details.";
        console.error(message);
        document.body.insertAdjacentHTML("beforeend", `<p>${message}</p>`);
      })();

      function setupIdentityUI() {
        if (!window.netlifyIdentity) {
          return;
        }

        const cleanIdentityModal = () => {
          const modal = document.querySelector(".netlify-identity-modal");
          if (!modal) return;

          const tabs = modal.querySelector("[data-netlify-identity-menu]");
          if (tabs) {
            tabs.style.display = "none";
          }

          modal.querySelectorAll("[data-netlify-identity-button]").forEach((button) => {
            const text = (button.textContent || "").toLowerCase();
            if (text.includes("sign up") || text.includes("signup") || text.includes("register")) {
              button.remove();
            }
          });

          const heading = modal.querySelector(".netlify-identity-title");
          if (heading) {
            heading.textContent = "Log in";
          }
        };

        window.netlifyIdentity.on("open", () => {
          cleanIdentityModal();
          const observer = new MutationObserver(() => cleanIdentityModal());
          const modal = document.querySelector(".netlify-identity-modal");
          if (modal) {
            observer.observe(modal, { childList: true, subtree: true });
          }
        });
      }

      function setupMobileShell() {
        const observer = new MutationObserver(() => applyMobileShell());
        observer.observe(document.body, { childList: true, subtree: true });
        applyMobileShell();
        window.addEventListener("hashchange", () => closeNav(), { passive: true });
      }

      function applyMobileShell() {
        const root = document.getElementById("nc-root");
        if (!root) return;

        root.classList.add("cms-mobile-root");
        ensureHeader(root);
        enhanceNav(root);
        simplifyContent(root);
      }

      function ensureHeader(root) {
        let header = document.getElementById("cms-mobile-header");
        if (!header) {
          header = document.createElement("header");
          header.id = "cms-mobile-header";
          header.className = "cms-mobile-header";
          header.innerHTML = `
            <button type="button" id="cms-nav-toggle" aria-expanded="false" aria-controls="cms-mobile-nav">
              <span class="cms-hamburger" aria-hidden="true"><span></span><span></span><span></span></span>
              Menu
            </button>
            <span class="cms-brand" aria-label="Admin home">TextMyLink Admin</span>
            <button
              type="button"
              id="cms-collections-toggle"
              class="cms-link-button"
              aria-expanded="false"
              aria-controls="cms-mobile-nav"
            >
              Collections
            </button>
            <button type="button" id="cms-logout-button" class="cms-link-button">Log out</button>
          `;
          document.body.insertBefore(header, root);

          const toggle = header.querySelector("#cms-nav-toggle");
          toggle.addEventListener("click", () => {
            const open = !document.body.classList.contains("cms-nav-open");
            document.body.classList.remove("cms-collections-open");
            if (open) {
              document.body.classList.add("cms-nav-open");
            } else {
              document.body.classList.remove("cms-nav-open");
            }
            updateNavState();
          });

          const collectionsToggle = header.querySelector("#cms-collections-toggle");
          collectionsToggle.addEventListener("click", () => {
            const open = !document.body.classList.contains("cms-collections-open");
            document.body.classList.remove("cms-nav-open");
            if (open) {
              document.body.classList.add("cms-collections-open");
            } else {
              document.body.classList.remove("cms-collections-open");
            }
            updateNavState();
          });

          const logout = header.querySelector("#cms-logout-button");
          logout.addEventListener("click", () => {
            if (window.netlifyIdentity) {
              window.netlifyIdentity.logout();
            }
          });
        }

        ensureNavMount(root);
        updateNavState();
      }

      function enhanceNav(root) {
        const nav =
          root.querySelector("[data-testid='collection-sidebar']") ||
          root.querySelector("nav[aria-label='Collections']") ||
          root.querySelector("aside[aria-label='Collections']");

        if (!nav) {
          return;
        }

        nav.id = "cms-mobile-nav";
        nav.classList.add("cms-mobile-nav");

        const mount = ensureNavMount(root);
        const wrappers = [
          nav.closest("[class*='MuiDrawer-root']"),
          nav.closest("div[role='presentation']"),
          nav.parentElement,
        ];

        let moved = false;
        for (const wrapper of wrappers) {
          if (!wrapper || wrapper === document.body || wrapper === document.documentElement) {
            continue;
          }
          if (!wrapper.contains(nav)) {
            continue;
          }
          if (!wrapper.dataset.cmsMobileMoved) {
            mount.appendChild(wrapper);
            wrapper.dataset.cmsMobileMoved = "true";
            wrapper.dataset.cmsMobileWrapper = "true";
          }
          flattenNavElement(wrapper);
          moved = true;
          break;
        }

        if (!moved && !nav.dataset.cmsMobileMoved) {
          mount.appendChild(nav);
          nav.dataset.cmsMobileMoved = "true";
          nav.dataset.cmsMobileWrapper = "true";
        }

        const flattenTargets = [
          nav,
          nav.parentElement,
          nav.closest("[class*='MuiPaper']"),
          nav.closest("div[role='presentation']"),
        ];
        flattenTargets.forEach(flattenNavElement);

        if (!nav.dataset.cmsMobileBound) {
          nav.dataset.cmsMobileBound = "true";
          nav.addEventListener("click", (event) => {
            if (event.target.closest("a, button")) {
              requestAnimationFrame(() => closeNav());
            }
          });
        }

        if (!document.body.classList.contains("cms-nav-open") && !document.body.classList.contains("cms-collections-open")) {
          const wrappers = mount.querySelectorAll("[data-cms-mobile-wrapper='true']");
          wrappers.forEach((wrapper) => {
            wrapper.hidden = true;
            wrapper.style.display = "none";
            wrapper.setAttribute("aria-hidden", "true");
          });
          nav.hidden = true;
          nav.style.display = "none";
          nav.setAttribute("aria-hidden", "true");
        }

        updateNavState();
      }

      function flattenNavElement(element) {
        if (!element || element === document.body || element === document.documentElement) {
          return;
        }

        element.style.position = "static";
        element.style.top = "";
        element.style.right = "";
        element.style.bottom = "";
        element.style.left = "";
        element.style.transform = "none";
        element.style.height = "auto";
        element.style.maxHeight = "none";
        element.style.width = "100%";
        element.style.maxWidth = "none";
        element.style.boxShadow = "none";
        element.style.background = "transparent";
        element.style.margin = "0";
        element.style.padding = element.id === "cms-mobile-nav" ? "0" : "";
        element.style.zIndex = "";
        element.style.opacity = element.id === "cms-mobile-nav" ? "" : "1";
      }

      function ensureNavMount(root) {
        let mount = document.getElementById("cms-mobile-nav-container");
        if (!mount) {
          mount = document.createElement("div");
          mount.id = "cms-mobile-nav-container";
          mount.setAttribute("aria-hidden", "true");
          mount.hidden = true;
          document.body.insertBefore(mount, root);
        }
        return mount;
      }

      function simplifyContent(root) {
        root
          .querySelectorAll("[data-testid='collection-content'], [data-testid='editor-pane'], main, [role='main']")
          .forEach((pane) => pane.classList.add("cms-mobile-pane"));

        root
          .querySelectorAll("[data-testid='entry-card'], [class*='EntryCard'], [class*='CollectionListCard']")
          .forEach((card) => card.classList.add("cms-condensed-card"));

        root.querySelectorAll("form").forEach((form) => {
          if (!form.dataset.cmsMobileBound) {
            form.dataset.cmsMobileBound = "true";
            form.addEventListener("submit", () => closeNav());
          }
        });
      }

      function updateNavState() {
        const open = document.body.classList.contains("cms-nav-open");
        const collectionsOpen = document.body.classList.contains("cms-collections-open");
        const button = document.getElementById("cms-nav-toggle");
        if (button) {
          button.setAttribute("aria-expanded", open ? "true" : "false");
        }
        const collectionsButton = document.getElementById("cms-collections-toggle");
        if (collectionsButton) {
          collectionsButton.setAttribute("aria-expanded", collectionsOpen ? "true" : "false");
        }
        const navContainer = document.getElementById("cms-mobile-nav-container");
        if (navContainer) {
          if (open || collectionsOpen) {
            navContainer.hidden = false;
            navContainer.setAttribute("aria-hidden", "false");
          } else {
            navContainer.hidden = true;
            navContainer.setAttribute("aria-hidden", "true");
          }

          const nav = navContainer.querySelector("#cms-mobile-nav");
          if (nav) {
            const showNav = open || collectionsOpen;
            nav.setAttribute("aria-hidden", showNav ? "false" : "true");
            nav.hidden = !showNav;
            nav.style.display = showNav ? "" : "none";
            const wrappers = navContainer.querySelectorAll("[data-cms-mobile-wrapper='true']");
            wrappers.forEach((wrapper) => {
              wrapper.hidden = !showNav;
              wrapper.style.display = showNav ? "" : "none";
              wrapper.setAttribute("aria-hidden", showNav ? "false" : "true");
            });
          }
        }
      }

      function closeNav() {
        if (!document.body.classList.contains("cms-nav-open") && !document.body.classList.contains("cms-collections-open")) {
          updateNavState();
          return;
        }
        document.body.classList.remove("cms-nav-open");
        document.body.classList.remove("cms-collections-open");
        updateNavState();
      }
    </script>
  </body>
</html>
